generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum SubjectType {
  USER
  ORG
}

enum OrgRole {
  OWNER
  ADMIN
  MEMBER
}

model User {
  id              String          @id @default(uuid()) @db.Uuid
  email           String          @unique
  name            String?
  passwordHash    String          @map("password_hash")
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")
  orgMemberships  OrgMember[]
  analyses        Analysis[]
  queryExecutions QueryExecution[]
  subscriptions   Subscription[]  @relation("user_subscriptions")
  usageCounters   UsageCounter[]  @relation("user_usage")
  projects        Project[]       @relation("user_projects")
  sessions        Session[]
  acceptedInvites OrgInvite[]     @relation("invite_acceptances")

  @@map("users")
}

model Organization {
  id             String          @id @default(uuid()) @db.Uuid
  name           String
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  members        OrgMember[]
  projects       Project[]
  invites        OrgInvite[]
  analyses       Analysis[]
  queryExecutions QueryExecution[]
  subscriptions  Subscription[]  @relation("org_subscriptions")
  usageCounters  UsageCounter[]  @relation("org_usage")

  @@map("organizations")
}

model OrgMember {
  id        String        @id @default(uuid()) @db.Uuid
  role      OrgRole       @default(MEMBER)
  userId    String        @db.Uuid @map("user_id")
  orgId     String        @db.Uuid @map("org_id")
  createdAt DateTime      @default(now()) @map("created_at")
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([userId, orgId])
  @@map("org_members")
}

model Project {
  id          String    @id @default(uuid()) @db.Uuid
  name        String
  orgId       String?   @db.Uuid @map("org_id")
  ownerUserId String?   @db.Uuid @map("owner_user_id")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  organization Organization? @relation(fields: [orgId], references: [id], onDelete: SetNull)
  ownerUser   User?     @relation("user_projects", fields: [ownerUserId], references: [id], onDelete: SetNull)
  analyses    Analysis[]
  queryExecutions QueryExecution[]
  apiTokens   ApiToken[]
  dbConnections ProjectDbConnection[]

  @@map("projects")
}

model Analysis {
  id          String    @id @default(uuid()) @db.Uuid
  projectId   String?   @db.Uuid @map("project_id")
  userId      String?   @db.Uuid @map("user_id")
  orgId       String?   @db.Uuid @map("org_id")
  sql         String
  explainJson Json      @map("explain_json")
  result      Json?     @map("result")
  status      String    @default("queued")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  project     Project?  @relation(fields: [projectId], references: [id], onDelete: SetNull)
  user        User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  organization Organization? @relation(fields: [orgId], references: [id], onDelete: SetNull)

  @@map("analyses")
}

model QueryExecution {
  id                     String   @id @default(uuid()) @db.Uuid
  projectId              String?  @db.Uuid @map("project_id")
  userId                 String?  @db.Uuid @map("user_id")
  orgId                  String?  @db.Uuid @map("org_id")
  sql                    String
  source                 String
  clientExtensionVersion String?  @map("client_extension_version")
  clientVscodeVersion    String?  @map("client_vscode_version")
  executionTimeMs        Int      @map("execution_time_ms")
  rowsReturned           Int      @map("rows_returned")
  createdAt              DateTime @default(now()) @map("created_at")
  project                Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  user                   User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  organization           Organization? @relation(fields: [orgId], references: [id], onDelete: SetNull)

  @@map("query_executions")
}

model ApiToken {
  id          String      @id @default(uuid()) @db.Uuid
  tokenHash   String      @unique @map("token_hash")
  label       String?
  subjectType SubjectType @map("subject_type")
  subjectId   String      @db.Uuid @map("subject_id")
  projectId   String?     @db.Uuid @map("project_id")
  createdAt   DateTime    @default(now()) @map("created_at")
  lastUsedAt  DateTime?   @map("last_used_at")
  revokedAt   DateTime?   @map("revoked_at")
  project     Project?    @relation(fields: [projectId], references: [id], onDelete: SetNull)

  @@map("api_tokens")
}

model Session {
  id         String   @id @default(uuid()) @db.Uuid
  tokenHash  String   @unique @map("token_hash")
  userId     String   @db.Uuid @map("user_id")
  createdAt  DateTime @default(now()) @map("created_at")
  expiresAt  DateTime @map("expires_at")
  revokedAt  DateTime? @map("revoked_at")
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model OrgInvite {
  id               String   @id @default(uuid()) @db.Uuid
  orgId            String   @db.Uuid @map("org_id")
  email            String
  role             OrgRole  @default(MEMBER)
  tokenHash        String   @unique @map("token_hash")
  createdAt        DateTime @default(now()) @map("created_at")
  expiresAt        DateTime? @map("expires_at")
  acceptedAt       DateTime? @map("accepted_at")
  acceptedByUserId String?  @db.Uuid @map("accepted_by_user_id")
  organization     Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  acceptedBy       User?    @relation("invite_acceptances", fields: [acceptedByUserId], references: [id], onDelete: SetNull)

  @@map("org_invites")
}

model Plan {
  id                   String         @id @default(uuid()) @db.Uuid
  code                 String         @unique
  name                 String
  monthlyAnalysisLimit Int            @map("monthly_analysis_limit")
  monthlyLlmCallLimit  Int            @map("monthly_llm_call_limit")
  createdAt            DateTime       @default(now()) @map("created_at")
  subscriptions        Subscription[]

  @@map("plans")
}

model Subscription {
  id          String      @id @default(uuid()) @db.Uuid
  planId      String      @db.Uuid @map("plan_id")
  subjectType SubjectType @map("subject_type")
  userId      String?     @db.Uuid @map("user_id")
  orgId       String?     @db.Uuid @map("org_id")
  createdAt   DateTime    @default(now()) @map("created_at")
  plan        Plan        @relation(fields: [planId], references: [id], onDelete: Cascade)
  user        User?       @relation("user_subscriptions", fields: [userId], references: [id], onDelete: SetNull)
  organization Organization? @relation("org_subscriptions", fields: [orgId], references: [id], onDelete: SetNull)

  @@map("subscriptions")
}

model UsageCounter {
  id             String      @id @default(uuid()) @db.Uuid
  subjectType    SubjectType @map("subject_type")
  userId         String?     @db.Uuid @map("user_id")
  orgId          String?     @db.Uuid @map("org_id")
  month          DateTime    @map("month")
  analysesCount  Int         @default(0) @map("analyses_count")
  llmCallsCount  Int         @default(0) @map("llm_calls_count")
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")
  user           User?       @relation("user_usage", fields: [userId], references: [id], onDelete: SetNull)
  organization   Organization? @relation("org_usage", fields: [orgId], references: [id], onDelete: SetNull)

  @@unique([subjectType, userId, orgId, month])
  @@map("usage_counters")
}

model ProjectDbConnection {
  id                   String   @id @default(uuid()) @db.Uuid
  projectId            String   @db.Uuid @map("project_id")
  type                 String   @default("postgres")
  name                 String
  encryptedCredentials Json     @map("encrypted_credentials")
  sslMode              String   @default("require") @map("ssl_mode")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")
  project              Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("project_db_connections")
}
